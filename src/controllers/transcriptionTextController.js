const axios = require("axios");

exports.summarizeTranscriptionText = async (req, res) => {
  const transcriptionText = req.body.transcriptionText;
  try {
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4o",
        messages: [
          {
            role: "system",
            content: `あなたは優秀なビジネスアナリストです。以下の商談文字起こし（口語体）をもとに、情報の抜け漏れがないように注意深く要約し、ビジネス文書として適切な文語表現（敬体）に変換した議事録を作成してください。以下の指示に従い、誤情報を避け、事実と推測を混同しないようにまとめてください。
							【目的】
							- 商談の録音を文字起こしした口語体のテキストから、要点を正確に抽出し、ビジネスで共有可能な議事録を作成すること。
							【議事録に含めるべき項目】
							1. 概要（サマリー）
							- 商談の背景、目的、参加者の大まかな役割
							- 全体の流れを簡潔に整理
							2. 企業情報
							- 企業名、業種、事業内容、担当者名、部署 など
							- 必要に応じて発言者を「先方」「自社」「不明」などと明記
							3. 先方の経営課題
							- 経営面の悩みや目標、課題の背景
							- 抱えているリスクや改善したいポイント
							4. 営業の課題
							- 先方が抱えている営業面の問題点、チームの課題
							- 具体的な売上目標やプロセス上の障害 など
							5. 自社の提案内容
							- 提案した製品・サービスやソリューションの概要
							- 導入メリット、競合優位性
							- 提案に対する先方の反応や懸念点 など
							6. 今後のステップ
							- 次回打ち合わせや日程調整、追加情報の提供など
							- 双方で合意したアクションアイテムと担当者


							---
							【出力時の重要ポイント】
							1. 口語体 → 文語体への変換
							- 口癖や無駄なフィラー（例：「えー」「あのー」「そうですね」など）は削除し、冗長表現を避ける。
							- 「～ですね」「～って感じ」といった砕けた表現は、適切な敬体表現に置き換える。
							- ただし、重要なニュアンスが変わらない範囲で行うこと。
							2. 情報の正確性確保
							- 発言者が曖昧な場合は「担当者（不明）」などと記載し、事実と推測を混同しない。
							- 不明瞭な点は「情報不足」または「具体的な言及なし」と明示し、誤った推測で補完しない。
							- 引用が必要な場合は、可能な範囲で原文の意味合いを保ちながら要約する。
							3. 要点の網羅性と簡潔さの両立
							- できる限り、指定した項目に関する重要情報を漏らさないようにする。
							- 一方で、重複表現や不要な文言は簡潔にまとめる。
							4. 事実と合意事項の優先度
							- 先方と自社で合意した内容、確認が必要な内容などは特に明確に記載する。
							- 推測や個人的な解釈は入れず、客観的事実に即した表現を最優先とする。
							5. 形式の見やすさ
							- 必要に応じて箇条書きや段落分けを活用し、読みやすい構成にする。
							- 社内外に展開しやすいよう、敬体（です・ます調）を基本としたビジネス文書スタイルを維持する。


							---
							【最終的な出力フォーマット（例）】
							- 【概要（サマリー）】
							〇月〇日に実施された商談。目的は△△の確認と提案のすり合わせ。
							参加者：●●社（担当：◯◯様）、自社（担当：××）など
							主なテーマは～（簡潔に要点）
							【企業情報】
							企業名：●●株式会社
							業種：ITサービス
							事業内容：システム開発・クラウドサービス提供
							担当者名・役職：◯◯様（営業部長）
							【先方の経営課題】
							◯◯の売上が伸び悩んでいる
							新規市場への進出に伴う人材不足
							現状の課題は△△（具体的に）
							【営業の課題】
							チーム内での目標設定が不明確
							◯◯件の商談獲得目標に対してKPI管理が十分でない
							【自社の提案内容】
							◯◯システム導入の提案
							導入メリット：業務効率化、コスト削減、情報共有の円滑化
							◯◯社が懸念する費用対効果については、△△を例示して説明
							【今後のステップ】
							1週間後に再度オンラインで打ち合わせ
							デモ版の利用環境を先方へ共有
							契約条件のすり合わせ：次回までに双方で要件を整理`,
          },
          {
            role: "user",
            content: `次の文章は商談の文字起こしテキストです。上記のルールを元に、文字起こしテキストを要約してください。
						出力形式を必ず守ってください。
						【文字起こしテキスト】
						${transcriptionText}`,
          },
        ],
        temperature: 0,
        max_tokens: 8192,
      },
      {
        headers: {
          Authorization: `Bearer ${process.env.REACT_APP_OPENAI_API_KEY}`,
          "Content-Type": "application/json",
        },
      }
    );

    res.json({
      status: "success",
      data: response.data.choices[0].message.content,
    });
  } catch (e) {
    console.log(e);
    res.json({
      status: "error",
      message: e.message,
    });
  }
};
